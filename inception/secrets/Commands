# syntax=docker/dockerfile:1.4

#SECTION - id_rsa

FROM alpine:latest

# Installa git o qualsiasi tool che deve usare la chiave
RUN apk add --no-cache git openssh

# Monta temporaneamente la chiave SSH privata come secret e clona
RUN --mount=type=secret,id=sshkey,target=/root/.ssh/id_rsa \
    chmod 600 /root/.ssh/id_rsa && \
    GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" \
    git clone git@github.com:utente/repo-privata.git /app

WORKDIR /app
CMD ["ls", "-la"]

#docker buildx build --secret id=sshkey,src=$HOME/.ssh/id_rsa .

#SECTION - awscli

RUN --mount=type=secret
#This mount type allows the build container to access secret values, such as tokens or private keys, without baking them into the image.

#By default, the secret is mounted as a file. You can also mount the secret as an environment variable by setting the env option.
#
#Option	Description
#id	ID of the secret. Defaults to basename of the target path.
#target, dst, destination	Mount the secret to the specified path. Defaults to /run/secrets/ + id if unset and if env is also unset.
#env	Mount the secret to an environment variable instead of a file, or both. (since Dockerfile v1.10.0)
#required	If set to true, the instruction errors out when the secret is unavailable. Defaults to false.
#mode	File mode for secret file in octal. Default 0400.
#uid	User ID for secret file. Default 0.
#gid	Group ID for secret file. Default 0.
#Example: access to S3

# syntax=docker/dockerfile:1
FROM python:3
RUN pip install awscli
RUN --mount=type=secret,id=aws,target=/root/.aws/credentials \
  aws s3 cp s3://... ...

# docker buildx build --secret id=aws,src=$HOME/.aws/credentials .
#Example: Mount as environment variable
#The following example takes the secret API_KEY and mounts it as an environment variable with the same name.


# syntax=docker/dockerfile:1
FROM alpine
RUN --mount=type=secret,id=API_KEY,env=API_KEY \
    some-command --token-from-env $API_KEY
#Assuming that the API_KEY environment variable is set in the build environment, you can build this with the following command:


# docker buildx build --secret id=API_KEY .



#version: '3.8'
#services:
#  myapp:
#    build:
#      context: .
#      secrets:
#        - db_pass
#        - creds

#secrets:
#  db_pass:
#    file: ./secrets/db_password.txt
#  creds:
#    file: ./secrets/credentials.txt